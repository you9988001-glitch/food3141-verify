<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>food3141 결제 테스트</title>

  <!-- Pi SDK -->
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 24px; background:#f7f7f8; }
    .card { max-width: 520px; margin: 0 auto; background: white; border-radius: 16px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
    h1 { margin: 0 0 8px; font-size: 28px; }
    p { margin: 0 0 14px; color: #333; line-height: 1.45; }
    button { width: 100%; padding: 14px 16px; border-radius: 14px; border: 0; font-size: 18px; cursor: pointer; }
    .primary { background: #6b4eff; color: white; margin-top: 10px; }
    .dark { background: #111; color: white; margin-top: 10px; }
    .status { margin-top: 12px; padding: 12px; background: #f1f1f3; border-radius: 12px; font-size: 14px; white-space: pre-wrap; }
    .small { font-size: 12px; color:#666; margin-top: 10px; }
  </style>
</head>

<body>
  <div class="card">
    <h1>food3141 결제 테스트</h1>
    <p>Step 10 통과용: 아래 버튼을 눌러 결제창을 띄우고 결제를 완료하세요.</p>

    <button class="primary" id="payBtn">0.01 Pi 결제 테스트</button>
    <button class="dark" id="apiBtn">API(서버) 테스트</button>

    <div class="status" id="status">대기 중…</div>
    <div class="small">※ “개발자가 승인 못함(시간초과)”가 뜨면 approve API 호출이 실패한 거예요.</div>
  </div>

  <script>
    const statusEl = document.getElementById("status");
    const setStatus = (msg) => statusEl.textContent = msg;

    // Pi SDK 초기화
    Pi.init({ version: "2.0" });

    async function ensureAuth() {
      // payments 권한 필요
      const auth = await Pi.authenticate(["payments"], onIncompletePaymentFound);
      return auth;
    }

    function onIncompletePaymentFound(payment) {
      // 중간에 끊긴 결제가 있으면 여기로 들어올 수 있음
      console.log("Incomplete payment found:", payment);
    }

    async function apiTest() {
      setStatus("API 테스트 중… (/api/approve 호출은 paymentId가 필요해서 지금은 /api 라우트 존재 여부만 확인)\n\n- 결제 버튼을 눌러 실제 승인/완료 흐름을 타야 합니다.");
      // 여기서는 단순 안내만.
    }

    async function startPayment() {
      try {
        setStatus("Pi 인증 중…");
        await ensureAuth();

        setStatus("결제 생성 중… (지갑 화면으로 넘어가면 승인/완료는 서버가 자동 처리해야 함)");

        const paymentData = {
          amount: 0.01,
          memo: "food3141 step10 test",
          metadata: { app: "food3141", purpose: "checklist-step10" },
        };

        const callbacks = {
          onReadyForServerApproval: async function(paymentId) {
            setStatus("서버 승인 요청 중…\npaymentId: " + paymentId);
            const r = await fetch("/api/approve", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId })
            });
            const j = await r.json().catch(() => ({}));
            if (!r.ok) throw new Error("approve failed: " + JSON.stringify(j));
            setStatus("서버 승인 완료 ✅\n이제 지갑에서 전송 승인 후, 서버 complete 단계로 갑니다.");
          },

          onReadyForServerCompletion: async function(paymentId, txid) {
            setStatus("서버 완료 요청 중…\npaymentId: " + paymentId + "\ntxid: " + txid);
            const r = await fetch("/api/complete", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ paymentId, txid })
            });
            const j = await r.json().catch(() => ({}));
            if (!r.ok) throw new Error("complete failed: " + JSON.stringify(j));
            setStatus("결제 완료 ✅ (complete까지 성공)\n이제 체크리스트에서 Step 10이 갱신되어야 합니다.");
          },

          onCancel: function(paymentId) {
            setStatus("사용자가 결제를 취소했어요.\npaymentId: " + paymentId);
          },

          onError: function(error, payment) {
            setStatus("에러 발생 ❌\n" + (error?.message || JSON.stringify(error)) + "\n\npayment:\n" + JSON.stringify(payment, null, 2));
          }
        };

        // sandbox 옵션은 여기서 건드리지 말고(헷갈림 방지),
        // 지금은 Step10 통과가 목표니까 기본 흐름으로 갑니다.
        Pi.createPayment(paymentData, callbacks);

      } catch (e) {
        setStatus("초기화/인증 실패 ❌\n" + String(e));
      }
    }

    document.getElementById("payBtn").addEventListener("click", startPayment);
    document.getElementById("apiBtn").addEventListener("click", apiTest);
  </script>
</body>
</html>
