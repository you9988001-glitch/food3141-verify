
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>food3141 - step10 test</title>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#fff; }
    .wrap { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .card { max-width:520px; width:100%; border:1px solid #e5e5e5; border-radius:16px; padding:20px; }
    h1 { font-size:22px; margin:0 0 8px; }
    p { margin:0 0 16px; line-height:1.4; color:#333; }
    button { width:100%; padding:14px 16px; font-size:16px; border-radius:12px; border:0; cursor:pointer; }
    .btn1 { background:#6a35ff; color:#fff; margin-bottom:10px; }
    .btn2 { background:#111; color:#fff; }
    .log { margin-top:14px; font-size:13px; white-space:pre-wrap; background:#f7f7f7; padding:12px; border-radius:12px; border:1px solid #eee; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>food3141 결제 테스트</h1>
      <p>Step 10 통과용: 아래 버튼을 눌러 결제창을 띄우고 결제를 완료하세요.</p>

      <button class="btn1" id="btnPay">0.01 Pi 결제 테스트</button>
      <button class="btn2" id="btnPing">API(서버) 테스트</button>

      <div class="log" id="log">준비됨</div>
    </div>
  </div>

  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>
    const logEl = document.getElementById('log');
    const log = (msg) => { logEl.textContent = msg; };

    async function startPayment() {
      try {
        if (!window.Pi) throw new Error("Pi SDK 로드 실패");

        Pi.init({ version: "2.0", sandbox: false });

        log("Pi 인증 중...");
        await Pi.authenticate(["payments"], () => {});
        log("인증 완료. 결제 생성 중...");

        await Pi.createPayment(
          { amount: 0.01, memo: "food3141 step10 test", metadata: { purpose: "step10" } },
          {
            onReadyForServerApproval: async (paymentId) => {
              log("승인 요청 중...");
              const r = await fetch("/api/approve", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ paymentId })
              });
              const t = await r.text();
              log("approve status " + r.status + ": " + t);
            },
            onReadyForServerCompletion: async (paymentId, txid) => {
              log("완료 요청 중...");
              const r = await fetch("/api/complete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ paymentId, txid })
              });
              const t = await r.text();
              log("complete status " + r.status + ": " + t);
            },
            onCancel: (paymentId) => log("취소: " + paymentId),
            onError: (error) => log("에러: " + (error?.message || String(error)))
          }
        );
      } catch (e) {
        log("실패: " + (e?.message || String(e)));
      }
    }

    async function pingApi() {
      try {
        const r = await fetch("/api/approve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paymentId: "TEST" })
        });
        const t = await r.text();
        log("API status " + r.status + ": " + t);
      } catch (e) {
        log("API 호출 실패: " + (e?.message || String(e)));
      }
    }

    document.getElementById("btnPay").addEventListener("click", startPayment);
    document.getElementById("btnPing").addEventListener("click", pingApi);
  </script>
</body>
</html>
